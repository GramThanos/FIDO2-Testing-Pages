<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>FIDO Testing</title>
		<meta name="description" content="Testing FIDO2 & WebAuthen">
		<meta name="author" content="UNIPI - FIDO Project 2019">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	</head>
	<body>
		<div class="container">
			<div style="text-align: center;">
				<h2>FIDO 2 Unipi</h2>
				<h4>Live testing FIDO2 & WebAuthen</h4>
			</div>
			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<nav class="navbar navbar-expand-lg navbar-light bg-light">
						<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
							<span class="navbar-toggler-icon"></span>
						</button>
						<div class="collapse navbar-collapse" id="navbarSupportedContent">
							<ul class="navbar-nav mr-auto">
								<li class="nav-item">
									<a class="nav-link" href="index.html">Home</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="credential-creation.html">Credential Creation</a>
								</li>
								<li class="nav-item active">
									<a class="nav-link" href="credential-get.html">Credential Get <span class="sr-only">(current)</span></a>
								</li>
							</ul>
						</div>
					</nav>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" id="webauthn-support" style="padding-bottom: 25px;display: none;">
					<div class="alert alert-danger" role="alert">
						WebAuthn is not supported by your browser.
					</div>
				</div>
				<script type="text/javascript">
					if (typeof window.navigator.credentials == 'undefined') {
						document.getElementById('webauthn-support').style.display = 'block';
						document.getElementById('login-with-fido').setAttribute('disabled', 'disabled');
					}
				</script>
			</div>



			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<h4>Credential Get</h4>
					<form id="credential-get-form">


						<div class="form-group">
							<h6>Randomized challenge</h6>
						</div>
						<div class="form-group">
							<label for="credential-get-challenge">challenge</label>
							<input type="text" class="form-control" id="credential-get-challenge" value="">
						</div>
						<script type="text/javascript">
							document.getElementById('credential-get-challenge').value = (function() {
								let id = [];
								for (var i = 31; i >= 0; i--) id.push(i);
								return JSON.stringify(id);
							})();
						</script>


						<div class="form-group">
							<h6>Timeout</h6>
						</div>
						<div class="form-group">
							<label for="credential-get-timeout">timeout</label>
							<input type="text" class="form-control" id="credential-get-timeout" value="120000">
						</div>

						<div class="form-group">
							<h6>Relaying Party entity</h6>
						</div>
						<div class="form-group">
							<label for="credential-get-rpid">rpId</label>
							<input type="text" class="form-control" id="credential-get-rpid" value="">
						</div>
						<script type="text/javascript">
							document.getElementById('credential-get-rpid').value = new URL(document.location.href).host;
						</script>


						<div class="form-group">
							<h6>Allow Credentials</h6>
						</div>
						<div class="form-group">
							<button type="button" class="btn btn-sm btn-outline-danger" style="float:right;" onclick="this.parentNode.getElementsByTagName('input')[0].value='';">clear</button>
							<label for="credential-get-publickeycredentialdescriptor-0-id">publickeycredentialdescriptor[0].id</label>
							<input type="text" class="form-control" id="credential-get-publickeycredentialdescriptor-0-id" value="">
						</div>
						<div class="form-group">
							<label for="credential-get-publickeycredentialdescriptor-0-transports">publickeycredentialdescriptor[0].transports</label>
							<select class="custom-select" multiple id="credential-get-publickeycredentialdescriptor-0-transports">
								<option value="" selected="selected">Don't set</option>
								<option value="usb">usb</option>
								<option value="nfc">nfc</option>
								<option value="ble">ble</option>
								<option value="internal">internal</option>
							</select>
						</div>
						<div class="form-group">
							<button type="button" class="btn btn-sm btn-outline-danger" style="float:right;" onclick="this.parentNode.getElementsByTagName('input')[0].value='';">clear</button>
							<label for="credential-get-publickeycredentialdescriptor-1-id">publickeycredentialdescriptor[1].id</label>
							<input type="text" class="form-control" id="credential-get-publickeycredentialdescriptor-1-id" value="">
						</div>
						<div class="form-group">
							<label for="credential-get-publickeycredentialdescriptor-1-transports">publickeycredentialdescriptor[1].transports</label>
							<select class="custom-select" multiple id="credential-get-publickeycredentialdescriptor-1-transports">
								<option value="" selected="selected">Don't set</option>
								<option value="usb">usb</option>
								<option value="nfc">nfc</option>
								<option value="ble">ble</option>
								<option value="internal">internal</option>
							</select>
						</div>
						<div class="form-group">
							<button type="button" class="btn btn-sm btn-outline-danger" style="float:right;" onclick="this.parentNode.getElementsByTagName('input')[0].value='';">clear</button>
							<label for="credential-get-publickeycredentialdescriptor-2-id">publickeycredentialdescriptor[2].id</label>
							<input type="text" class="form-control" id="credential-get-publickeycredentialdescriptor-2-id" value="">
						</div>
						<div class="form-group">
							<label for="credential-get-publickeycredentialdescriptor-2-transports">publickeycredentialdescriptor[2].transports</label>
							<select class="custom-select" multiple id="credential-get-publickeycredentialdescriptor-2-transports">
								<option value="" selected="selected">Don't set</option>
								<option value="usb">usb</option>
								<option value="nfc">nfc</option>
								<option value="ble">ble</option>
								<option value="internal">internal</option>
							</select>
						</div>
						<script type="text/javascript">
							(function(){
								let credentials = window.localStorage.getItem('credentials');
								if (!credentials) credentials = '[]';
								credentials = JSON.parse(credentials);
								// If key exists
								for (let i = 0; i <= 2 && i < credentials.length; i++) {
									document.getElementById('credential-get-publickeycredentialdescriptor-' + i + '-id').value = credentials[i];
								}
							})();
						</script>


						<div class="form-group">
							<h6>User Verification</h6>
						</div>
						<div class="form-group">
							<label for="credential-get-userVerification">userVerification</label>
							<select class="form-control" id="credential-get-userVerification">
								<option value="" selected="selected">Don't set</option>
								<option value="required">required</option>
								<option value="preferred">preferred (default)</option>
								<option value="discouraged">discouraged</option>
							</select>
						</div>


						<div class="form-group">
							<h6>Extensions</h6>
						</div>
						<div class="form-group">
							<label for="credential-get-extensions-exts">extensions.exts (Supported Extensions Extension)</label>
							<select class="form-control" id="credential-get-extensions-exts">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-get-extensions-uvi">extensions.uvi (User Verification Index Extension)</label>
							<select class="form-control" id="credential-get-extensions-uvi">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-get-extensions-loc">extensions.loc (Location Extension)</label>
							<select class="form-control" id="credential-get-extensions-loc">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-get-extensions-uvm">extensions.uvm (User Verification Method Extension)</label>
							<select class="form-control" id="credential-get-extensions-uvm">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>


						<button type="submit" class="btn btn-primary" id="credential-get-generate">Generate Options</button>
					</form>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<div class="alert alert-warning" role="alert">
						<pre id="credential-get-options">...</pre>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<button type="button" class="btn btn-primary" id="credential-get-get">Get Credentials</button>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<div class="alert alert-warning" role="alert">
						<pre id="credential-get-result">...</pre>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;font-size: 12px;text-align: right;">
					<p>
						FIDO Project 2019-2020<br>
						University of Piraeus<br>
						Department of Digital Systems<br>
					</p>
				</div>
				<div class="col-sm" style="padding-bottom: 25px;font-size: 12px;">
					<p>
						Kostas Sarikioses<br>
						Dimitris Georgilakis<br>
						Athanasios Vasileios Grammatopoulos<br>
					</p>
				</div>
			</div>

		</div>
		
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/gh/paroga/cbor-js/cbor.js" integrity="sha384-vKAKWtdV9tnI4r0kMCuDfK71rjynkScU/ty5A9h/6+LPU4uu+XNqRCX89iBSCzxh" crossorigin="anonymous"></script>

		<script type="text/javascript">
			// Global options variable
			// Shared between functions
			var options = null;

			// On form submit
			$('#credential-get-form').submit(() => {
				let val, count, opt;

				// Init options object
				options = {publicKey: {}};
				
				options.publicKey.challenge = tools.convert(JSON.parse($('#credential-get-challenge').val()));

				val = $('#credential-get-timeout').val();
				if (val.length != 0) {
					options.publicKey.timeout = parseInt(val, 10);
				}

				options.publicKey.rpId = $('#credential-get-rpid').val();
				
				options.publicKey.allowCredentials = [];
				// If key exists
				for (let i = 0; i <= 2; i++) {
					val = $('#credential-get-publickeycredentialdescriptor-' + i + '-id').val();
					if (val.length > 0) {
						opt = {type: "public-key", id: val};
						// If transports
						val = $('#credential-get-publickeycredentialdescriptor-' + i + '-transports').val();
						let index = val.indexOf("");
						if (index !== -1) val.splice(index, 1);
						if (val.length > 0) {
							opt.transports = val;
						}
						options.publicKey.allowCredentials.push(opt);
					}
				}
				
				val = $('#credential-get-userVerification').val();
				if (val.length != 0) {
					count++;
					options.publicKey.userVerification = val;
				}

				opt = {};
				count = 0;
				val = $('#credential-get-extensions-exts').val();
				if (val.length != 0) {
					count++;
					opt.exts = true;
				}
				val = $('#credential-get-extensions-uvi').val();
				if (val.length != 0) {
					count++;
					opt.uvi = true;
				}
				val = $('#credential-get-extensions-loc').val();
				if (val.length != 0) {
					count++;
					opt.loc = true;
				}
				val = $('#credential-get-extensions-uvm').val();
				if (val.length != 0) {
					count++;
					opt.uvm = true;
				}
				if (count > 0) {
					options.publicKey.extensions = opt;
				}

				// Show it
				$('#credential-get-options').html(
					'[CredentialGetOptions] ' + 
					JSON.stringify(options, null, 4).replace(/\n            \s*(\d+)/g, '$1').replace(/\n        \s*\]/g, ']')
				);

				

				//options.publicKey.user.id = tools.convert(options.publicKey.user.id);
				options.publicKey.challenge = tools.convert(options.publicKey.challenge);
				for (var i = options.publicKey.allowCredentials.length - 1; i >= 0; i--) {
					options.publicKey.allowCredentials[i].id = tools.convert(options.publicKey.allowCredentials[i].id);
				}

				return false;
			});

			$('#credential-get-get').click(() => {
				console.log('credentials.get', options);
				let p = navigator.credentials.get(options);
				p.then((credential) => {
					window._credential = credential;
					console.log('[PublicKeyCredential]', credential);

					// decode the clientDataJSON into a utf-8 string
					const utf8Decoder = new TextDecoder('utf-8');
					const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON);
					// parse the string as an object
					const clientDataObj = JSON.parse(decodedClientData);
					console.log('[ClientDataObject]', clientDataObj);

					extensions = credential.getClientExtensionResults();
					console.log('[ClientExtensionResults]', extensions);

					$('#credential-get-result').html(

						'[PublicKeyCredential] ' +
						JSON.stringify({
							rawId: tools.convert(credential.rawId),
							response: {
								authenticatorData: tools.convert(credential.response.authenticatorData),
								signature: tools.convert(credential.response.signature),
								userHandle: credential.response.userHandle instanceof ArrayBuffer ? tools.convert(credential.response.userHandle) : credential.response.userHandle,
								clientDataJSON : clientDataObj
							},
							id: credential.id,
							type: credential.type
						}, null, 4).replace(/\n\s*(\d+)/g, '$1').replace(/\n\s*\]/g, ']')
						
						+ '\n\n' + 
						
						'[ClientExtensionResults] ' +
						JSON.stringify(extensions, null, 4)
					);


				}).catch((e) => {
					$('#credential-get-result').html(e.message);
					console.log(e);
				});

				return false;
			});
		</script>

		<script type="text/javascript">
			// Tools
			const tools = {
				convert : function(data) {
					if (typeof data === 'string') {
						return this.base64urlToUint8Array(data);
					}
					else if (data instanceof Uint8Array) {
						return this.uint8ArrayToBase64url(data);
					}
					else if (data instanceof Array || data instanceof ArrayBuffer) {
						return this.uint8ArrayToBase64url(new Uint8Array(data));
					}
					throw 'Convert error';
				},


				base64urlToUint8Array : function(base64url) {
					return this.base64ToUint8Array(this.base64urlToBase64(base64url));
				},
				base64ToUint8Array : function(base64) {
					var raw = window.atob(base64);
					var rawLength = raw.length;
					var array = new Uint8Array(new ArrayBuffer(rawLength));

					for(i = 0; i < rawLength; i++) {
						array[i] = raw.charCodeAt(i);
					}
					return array;
				},
				base64urlToBase64 : function(base64url) {
				    var base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
					while(base64.length % 4 != 0){
						base64 += '=';
					}
				    return base64;
				},


				uint8ArrayToBase64url : function(array) {
					return this.base64ToBase64url(this.uint8ArrayToBase64(array));
				},
				uint8ArrayToBase64 : function(array) {
					var str = String.fromCharCode.apply(null, new Uint8Array(array));
					return window.btoa(str);
				},
				base64ToBase64url : function(base64) {
					var base64url = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=*$/, '');
					return base64url;
				},
				uint8ArrayToInt : function(array, length = 0) {
					if (length == 0) length = array.length;
					var dataView = new DataView(new ArrayBuffer(length));
					array.forEach((value, index) => dataView.setUint8(index, value));
					return dataView['getUint' + (length * 8)]();
				}
			}
		</script>
	</body>
</html>
