<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>FIDO Testing</title>
		<meta name="description" content="Testing FIDO2 & WebAuthen">
		<meta name="author" content="UNIPI - FIDO Project 2019">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	</head>
	<body>
		<div class="container">
			<div style="text-align: center;">
				<h2>FIDO 2 Unipi</h2>
				<h4>Live testing FIDO2 & WebAuthen</h4>
			</div>
			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<nav class="navbar navbar-expand-lg navbar-light bg-light">
						<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
							<span class="navbar-toggler-icon"></span>
						</button>
						<div class="collapse navbar-collapse" id="navbarSupportedContent">
							<ul class="navbar-nav mr-auto">
								<li class="nav-item">
									<a class="nav-link" href="index.html">Home</a>
								</li>
								<li class="nav-item active">
									<a class="nav-link" href="credential-creation.html">Credential Creation <span class="sr-only">(current)</span></a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="credential-get.html">Credential Get</a>
								</li>
							</ul>
						</div>
					</nav>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" id="webauthn-support" style="padding-bottom: 25px;display: none;">
					<div class="alert alert-danger" role="alert">
						WebAuthn is not supported by your browser.
					</div>
				</div>
				<script type="text/javascript">
					if (typeof window.navigator.credentials == 'undefined') {
						document.getElementById('webauthn-support').style.display = 'block';
						document.getElementById('login-with-fido').setAttribute('disabled', 'disabled');
					}
				</script>
			</div>



			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<h4>Credential Creation</h4>
					<form id="credential-creation-form">


						<div class="form-group">
							<h6>Relaying Party entity</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-rp-name">rp.name</label>
							<input type="text" class="form-control" id="credential-creation-rp-name" value="FIDO 2 Unipi">
						</div>
						<div class="form-group">
							<label for="credential-creation-rp-id">rp.id</label>
							<input type="text" class="form-control" id="credential-creation-rp-id" value="">
						</div>
						<script type="text/javascript">
							document.getElementById('credential-creation-rp-id').value = new URL(document.location.href).host;
						</script>


						<div class="form-group">
							<h6>User account info</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-user-name">user.name</label>
							<input type="text" class="form-control" id="credential-creation-user-name" value="john.smith@email.com">
						</div>
						<div class="form-group">
							<label for="credential-creation-user-displayName">user.displayName</label>
							<input type="text" class="form-control" id="credential-creation-user-displayName" value="J. Smith">
						</div>
						<div class="form-group">
							<label for="credential-creation-user-id">user.id</label>
							<input type="text" class="form-control" id="credential-creation-user-id" value="">
						</div>
						<script type="text/javascript">
							document.getElementById('credential-creation-user-id').value = (function() {
								let id = [];
								for (var i = 0; i < 32; i++) id.push(i);
								return JSON.stringify(id);
							})();
						</script>


						<div class="form-group">
							<h6>Randomized challenge</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-challenge">challenge</label>
							<input type="text" class="form-control" id="credential-creation-challenge" value="">
						</div>
						<script type="text/javascript">
							document.getElementById('credential-creation-challenge').value = (function() {
								let id = [];
								for (var i = 31; i >= 0; i--) id.push(i);
								return JSON.stringify(id);
							})();
						</script>


						<div class="form-group">
							<h6>Credentials properties</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-pubKeyCredParams-0">pubKeyCredParams[0]</label>
							<select class="form-control" id="credential-creation-pubKeyCredParams-0">
								<option value="-7" selected="selected">(-7) ES256: ECDSA w/ SHA-256</option>
								<option value="-35">(-35) ES384: ECDSA w/ SHA-384</option>
								<option value="-36">(-36) ES512: ECDSA w/ SHA-512</option>
								<option value="-37">(-37) PS256: RSASSA-PSS w/ SHA-256</option>
								<option value="-38">(-38) PS384: RSASSA-PSS w/ SHA-384</option>
								<option value="-39">(-39) PS512: RSASSA-PSS w/ SHA-512</option>
								<option value="-257">(-257) RS256: RSASSA-PKCS1-v1_5 w/ SHA-256</option>
								<option value="-258">(-258) RS384: RSASSA-PKCS1-v1_5 w/ SHA-384</option>
								<option value="-259">(-259) RS512: RSASSA-PKCS1-v1_5 w/ SHA-512</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-pubKeyCredParams-1">pubKeyCredParams[1]</label>
							<select class="form-control" id="credential-creation-pubKeyCredParams-1">
								<option value="-7">(-7) ES256: ECDSA w/ SHA-256</option>
								<option value="-35">(-35) ES384: ECDSA w/ SHA-384</option>
								<option value="-36">(-36) ES512: ECDSA w/ SHA-512</option>
								<option value="-37" selected="selected">(-37) PS256: RSASSA-PSS w/ SHA-256</option>
								<option value="-38">(-38) PS384: RSASSA-PSS w/ SHA-384</option>
								<option value="-39">(-39) PS512: RSASSA-PSS w/ SHA-512</option>
								<option value="-257">(-257) RS256: RSASSA-PKCS1-v1_5 w/ SHA-256</option>
								<option value="-258">(-258) RS384: RSASSA-PKCS1-v1_5 w/ SHA-384</option>
								<option value="-259">(-259) RS512: RSASSA-PKCS1-v1_5 w/ SHA-512</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-pubKeyCredParams-2">pubKeyCredParams[2]</label>
							<select class="form-control" id="credential-creation-pubKeyCredParams-2">
								<option value="-7">(-7) ES256: ECDSA w/ SHA-256</option>
								<option value="-35">(-35) ES384: ECDSA w/ SHA-384</option>
								<option value="-36">(-36) ES512: ECDSA w/ SHA-512</option>
								<option value="-37">(-37) PS256: RSASSA-PSS w/ SHA-256</option>
								<option value="-38">(-38) PS384: RSASSA-PSS w/ SHA-384</option>
								<option value="-39">(-39) PS512: RSASSA-PSS w/ SHA-512</option>
								<option value="-257" selected="selected">(-257) RS256: RSASSA-PKCS1-v1_5 w/ SHA-256</option>
								<option value="-258">(-258) RS384: RSASSA-PKCS1-v1_5 w/ SHA-384</option>
								<option value="-259">(-259) RS512: RSASSA-PKCS1-v1_5 w/ SHA-512</option>
							</select>
						</div>


						<div class="form-group">
							<h6>Timeout</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-timeout">timeout</label>
							<input type="text" class="form-control" id="credential-creation-timeout" value="120000">
						</div>


						<div class="form-group">
							<h6>Authenticator selection criteria</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-authenticatorSelection-authenticatorAttachment">authenticatorSelection.authenticatorAttachment</label>
							<select class="form-control" id="credential-creation-authenticatorSelection-authenticatorAttachment">
								<option value="" selected="selected">Don't set</option>
								<option value="platform">platform</option>
								<option value="cross-platform">cross-platform</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-authenticatorSelection-requireResidentKey">authenticatorSelection.requireResidentKey</label>
							<select class="form-control" id="credential-creation-authenticatorSelection-requireResidentKey">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
								<option value="false">false (default)</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-authenticatorSelection-userVerification">authenticatorSelection.userVerification</label>
							<select class="form-control" id="credential-creation-authenticatorSelection-userVerification">
								<option value="" selected="selected">Don't set</option>
								<option value="required">required</option>
								<option value="preferred">preferred (default)</option>
								<option value="discouraged">discouraged</option>
							</select>
						</div>


						<div class="form-group">
							<h6>Preference for attestation</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-attestation">attestation</label>
							<select class="form-control" id="credential-creation-attestation">
								<option value="" selected="selected">Don't set</option>
								<option value="none">none</option>
								<option value="indirect">indirect</option>
								<option value="direct">direct</option>
							</select>
						</div>


						<div class="form-group">
							<h6>Extensions</h6>
						</div>
						<div class="form-group">
							<label for="credential-creation-extensions-exts">extensions.exts (Supported Extensions Extension)</label>
							<select class="form-control" id="credential-creation-extensions-exts">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-extensions-uvi">extensions.uvi (User Verification Index Extension)</label>
							<select class="form-control" id="credential-creation-extensions-uvi">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-extensions-loc">extensions.loc (Location Extension)</label>
							<select class="form-control" id="credential-creation-extensions-loc">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>
						<div class="form-group">
							<label for="credential-creation-extensions-uvm">extensions.uvm (User Verification Method Extension)</label>
							<select class="form-control" id="credential-creation-extensions-uvm">
								<option value="" selected="selected">Don't set</option>
								<option value="true">true</option>
							</select>
						</div>


						<button type="submit" class="btn btn-primary" id="credential-creation-generate">Generate Options</button>
					</form>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<div class="alert alert-warning" role="alert">
						<pre id="credential-creation-options">...</pre>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<button type="button" class="btn btn-primary" id="credential-creation-create">Create Credentials</button>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;">
					<div class="alert alert-warning" role="alert">
						<pre id="credential-creation-result">...</pre>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm" style="padding-bottom: 25px;font-size: 12px;text-align: right;">
					<p>
						FIDO Project 2019-2020<br>
						University of Piraeus<br>
						Department of Digital Systems<br>
					</p>
				</div>
				<div class="col-sm" style="padding-bottom: 25px;font-size: 12px;">
					<p>
						Kostas Sarikioses<br>
						Dimitris Georgilakis<br>
						Athanasios Vasileios Grammatopoulos<br>
					</p>
				</div>
			</div>

		</div>
		
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/gh/paroga/cbor-js/cbor.js" integrity="sha384-vKAKWtdV9tnI4r0kMCuDfK71rjynkScU/ty5A9h/6+LPU4uu+XNqRCX89iBSCzxh" crossorigin="anonymous"></script>

		<script type="text/javascript">
			// Global options variable
			// Shared between functions
			var options = null;

			// On form submit
			$('#credential-creation-form').submit(() => {
				// Init options object
				options = {publicKey: {}};

				options.publicKey.rp = {};
				options.publicKey.rp.name = $('#credential-creation-rp-name').val();
				options.publicKey.rp.id = $('#credential-creation-rp-id').val();

				options.publicKey.user = {};
				options.publicKey.user.name = $('#credential-creation-user-name').val();
				options.publicKey.user.displayName = $('#credential-creation-user-displayName').val();
				options.publicKey.user.id = tools.convert(JSON.parse($('#credential-creation-user-id').val())); //new Uint8Array(JSON.parse($('#credential-creation-user-id').val()));

				options.publicKey.challenge = tools.convert(JSON.parse($('#credential-creation-challenge').val())); //new Uint8Array(JSON.parse($('#credential-creation-challenge').val()));

				options.publicKey.pubKeyCredParams = [];
				options.publicKey.pubKeyCredParams.push({type: "public-key", alg: JSON.parse($('#credential-creation-pubKeyCredParams-0').val())});
				options.publicKey.pubKeyCredParams.push({type: "public-key", alg: JSON.parse($('#credential-creation-pubKeyCredParams-1').val())});
				options.publicKey.pubKeyCredParams.push({type: "public-key", alg: JSON.parse($('#credential-creation-pubKeyCredParams-2').val())});

				let val, count, opt;

				val = $('#credential-creation-timeout').val();
				if (val.length != 0) {
					options.publicKey.timeout = parseInt(val, 10);
				}

				opt = {};
				count = 0;
				val = $('#credential-creation-authenticatorSelection-authenticatorAttachment').val();
				if (val.length != 0) {
					count++;
					opt.authenticatorAttachment = val;
				}
				val = $('#credential-creation-authenticatorSelection-requireResidentKey').val();
				if (val.length != 0) {
					count++;
					opt.requireResidentKey = JSON.parse(val);
				}
				val = $('#credential-creation-authenticatorSelection-userVerification').val();
				if (val.length != 0) {
					count++;
					opt.userVerification = val;
				}
				if (count > 0) {
					options.publicKey.authenticatorSelection = opt;
				}

				val = $('#credential-creation-attestation').val();
				if (val.length != 0) {
					options.publicKey.attestation = val;
				}

				opt = {};
				count = 0;
				val = $('#credential-creation-extensions-exts').val();
				if (val.length != 0) {
					count++;
					opt.exts = true;
				}
				val = $('#credential-creation-extensions-uvi').val();
				if (val.length != 0) {
					count++;
					opt.uvi = true;
				}
				val = $('#credential-creation-extensions-loc').val();
				if (val.length != 0) {
					count++;
					opt.loc = true;
				}
				val = $('#credential-creation-extensions-uvm').val();
				if (val.length != 0) {
					count++;
					opt.uvm = true;
				}
				if (count > 0) {
					options.publicKey.extensions = opt;
				}

				// Show it
				$('#credential-creation-options').html(
					'[CredentialCreationOptions] ' + 
					JSON.stringify(options, null, 4).replace(/\n            \s*(\d+)/g, '$1').replace(/\n        \s*\]/g, ']')
				);

				

				options.publicKey.user.id = tools.convert(options.publicKey.user.id);
				options.publicKey.challenge = tools.convert(options.publicKey.challenge);

				return false;
			});

			$('#credential-creation-create').click(() => {
				console.log('credentials.create', options);
				let p = navigator.credentials.create(options);
				p.then((credential) => {
					window._credential = credential;
					console.log('[PublicKeyCredential]', credential);

					// decode the clientDataJSON into a utf-8 string
					const utf8Decoder = new TextDecoder('utf-8');
					const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON);
					// parse the string as an object
					const clientDataObj = JSON.parse(decodedClientData);
					console.log('[ClientDataObject]', clientDataObj);


					const decodedAttestationObject = CBOR.decode(credential.response.attestationObject);
					console.log('[Decoded][AttestationObject]', decodedAttestationObject);

					const {authData} = decodedAttestationObject;
					// https://www.w3.org/TR/webauthn/#attestation-object

					//packed
					var authenticatorData = {};
					authenticatorData.rp_id_hash = tools.convert(authData.slice(0, 32));
					authenticatorData.flags = tools.uint8ArrayToInt(authData.slice(32, 32+1)).toString(2);
					authenticatorData.counter = tools.uint8ArrayToInt(authData.slice(32+1, 32+1+4));
					authenticatorData.attested_cred_data = {};
					authenticatorData.attested_cred_data.aaguid = tools.convert(authData.slice(32+1+4, 32+1+4+16));
					authenticatorData.attested_cred_data.l = tools.uint8ArrayToInt(authData.slice(32+1+4+16, 32+1+4+16+2));
					var l = authenticatorData.attested_cred_data.l;
					authenticatorData.attested_cred_data.credential_id = tools.convert(authData.slice(32+1+4+16+2, 32+1+4+16+2+l));
					//authenticatorData.attested_cred_data.credential_public_key = tools.convert(authData.slice(32+1+4+16+2+l, authData.length));
					authenticatorData.attested_cred_data.credential_public_key = CBOR.decode(authData.slice(32+1+4+16+2+l, authData.length).buffer);
					var pubkey = authenticatorData.attested_cred_data.credential_public_key;
					for (let i in pubkey) {
						if (pubkey.hasOwnProperty(i) && pubkey[i] instanceof Uint8Array) {
							pubkey[i] = tools.convert(pubkey[i]);
						}
					}
					console.log('[AuthenticatorData]', authenticatorData);

					// get the length of the credential ID
					var dataView = new DataView(new ArrayBuffer(2));
					const idLenBytes = authData.slice(53, 55);
					idLenBytes.forEach((value, index) => dataView.setUint8(index, value));
					const credentialIdLength = dataView.getUint16();
					// get the credential ID
					const credentialId = authData.slice(55, 55 + credentialIdLength);
					// get the public key object
					const publicKeyBytes = authData.slice(55 + credentialIdLength);
					// the publicKeyBytes are encoded again as CBOR
					const publicKeyObject = CBOR.decode(publicKeyBytes.buffer);
					console.log('[Decoded][AttestationObject][AuthData][PublicKeyObject]', publicKeyObject);
					for (let i in publicKeyObject) {
						if (publicKeyObject.hasOwnProperty(i) && publicKeyObject[i] instanceof Uint8Array) {
							publicKeyObject[i] = tools.convert(publicKeyObject[i]);
						}
					}


					decodedAttestationObject.authData = tools.convert(decodedAttestationObject.authData);
					clientDataObj.challenge = clientDataObj.challenge;

					if (decodedAttestationObject.hasOwnProperty('attStmt')){
						if (decodedAttestationObject.attStmt.hasOwnProperty('sig')) {
							decodedAttestationObject.attStmt.sig = tools.convert(decodedAttestationObject.attStmt.sig);
						}
						if (decodedAttestationObject.attStmt.hasOwnProperty('x5c')) {
							for (var i = 0; i < decodedAttestationObject.attStmt.x5c.length; i++) {
								decodedAttestationObject.attStmt.x5c[i] = tools.convert(decodedAttestationObject.attStmt.x5c[i]);
							}
						}
					}

					extensions = credential.getClientExtensionResults();
					console.log('[ClientExtensionResults]', extensions);

					$('#credential-creation-result').html(

						'[PublicKeyCredential] ' +
						JSON.stringify({
							rawId: tools.convert(credential.rawId),
							response: {
								attestationObject: decodedAttestationObject,
								clientDataJSON: clientDataObj
							},
							id: credential.id,
							type: credential.type
						}, null, 4).replace(/\n\s*(\d+)/g, '$1').replace(/\n\s*\]/g, ']')
						
						+ '\n\n' + 
						
						'[ClientExtensionResults] ' +
						JSON.stringify(extensions, null, 4)
						
						+ '\n\n' + 
						
						'[AttestationObject][AuthData] ' +
						JSON.stringify(authenticatorData, null, 4)
					);

					// Add to list
					let credentials = window.localStorage.getItem('credentials');
					if (!credentials) credentials = '[]';
					credentials = JSON.parse(credentials);
					credentials.unshift(tools.convert(credential.rawId));
					window.localStorage.setItem('credentials', JSON.stringify(credentials.slice(0, 3)));

				}).catch((e) => {
					$('#credential-creation-result').html(e.message);
					console.log(e);
				});

				return false;
			});
		</script>

		<script type="text/javascript">
			// Tools
			const tools = {
				convert : function(data) {
					if (typeof data === 'string') {
						return this.base64urlToUint8Array(data);
					}
					else if (data instanceof Uint8Array) {
						return this.uint8ArrayToBase64url(data);
					}
					else if (data instanceof Array || data instanceof ArrayBuffer) {
						return this.uint8ArrayToBase64url(new Uint8Array(data));
					}
					throw 'Convert error';
				},


				base64urlToUint8Array : function(base64url) {
					return this.base64ToUint8Array(this.base64urlToBase64(base64url));
				},
				base64ToUint8Array : function(base64) {
					var raw = window.atob(base64);
					var rawLength = raw.length;
					var array = new Uint8Array(new ArrayBuffer(rawLength));

					for(i = 0; i < rawLength; i++) {
						array[i] = raw.charCodeAt(i);
					}
					return array;
				},
				base64urlToBase64 : function(base64url) {
				    var base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
					while(base64.length % 4 != 0){
						base64 += '=';
					}
				    return base64;
				},


				uint8ArrayToBase64url : function(array) {
					return this.base64ToBase64url(this.uint8ArrayToBase64(array));
				},
				uint8ArrayToBase64 : function(array) {
					var str = String.fromCharCode.apply(null, new Uint8Array(array));
					return window.btoa(str);
				},
				base64ToBase64url : function(base64) {
					var base64url = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=*$/, '');
					return base64url;
				},
				uint8ArrayToInt : function(array, length = 0) {
					if (length == 0) length = array.length;
					var dataView = new DataView(new ArrayBuffer(length));
					array.forEach((value, index) => dataView.setUint8(index, value));
					return dataView['getUint' + (length * 8)]();
				}
			}
		</script>
	</body>
</html>
